<div class="container">
  <h1>Quiz</h1>

  <div *ngIf="loading">Chargement...</div>
  <div *ngIf="error">{{ error }}</div>

  <ng-container *ngIf="!loading && !error">
    <div *ngIf="current as q; else finished">

      <!-- TOP BAR -->
      <div class="topbar">
        <div>Question {{ index + 1 }} / {{ questions.length }}</div>
        <div class="topbar-right">
          <span>Score: {{ score }}</span>
          <a class="back-home" [routerLink]="'/'">Accueil</a>
        </div>
      </div>

      <!-- QUESTION -->
      <h2 class="question" [innerHTML]="q.question"></h2>

      <!-- IMAGE CLIQUABLE -->
      <div *ngIf="q.image" class="image-click-wrap" (click)="openImage()">
        <img
          class="question-image"
          [src]="q.image"
          [alt]="'Illustration de la question ' + (index + 1)"
        />
        <span class="image-zoom-badge">üîç Agrandir</span>
      </div>

      <!-- CHOIX -->
      <div class="choices">
        <button
          *ngFor="let c of q.choices"
          (click)="select(c.key)"
          [class.selected]="selected === c.key"
          [class.correct]="showCorrection && c.key === q.answer"
          [class.wrong]="showCorrection && selected === c.key && c.key !== q.answer"
        >
          <span class="key">{{ c.key.toUpperCase() }}</span>
          <span [innerHTML]="c.text"></span>
        </button>
      </div>

      <!-- NAVIGATION (TOUJOURS VISIBLE) -->
      <div class="nav-buttons">
        <button
          class="prev"
          (click)="previous()"
          [disabled]="index === 0"
        >
          Pr√©c√©dent
        </button>

        <button
          class="next"
          (click)="next()"
          [disabled]="!canGoNext"
        >
          {{ index === questions.length - 1 ? 'Terminer' : 'Suivant' }}
        </button>
      </div>

      <!-- FEEDBACK -->
      <div class="feedback" *ngIf="showCorrection">
        <p *ngIf="isCorrect" class="ok">‚úÖ Correct</p>
        <p *ngIf="isCorrect === false" class="no">
          ‚ùå Faux (bonne r√©ponse : {{ q.answer.toUpperCase() }})
        </p>

        <p *ngIf="q.explanation" [innerHTML]="q.explanation"></p>
      </div>

    </div>

    <!-- FIN DU QUIZ -->
    <ng-template #finished>
      <h2>Termin√© üéâ</h2>

      <!-- ‚úÖ SUCC√àS : bouton visible en haut -->
      <div class="success-actions" *ngIf="passed">
        <button class="train-again" (click)="startNewRandomQuiz()">
          Je m'entra√Æne encore avec un nouveau quiz al√©atoire
        </button>
      </div>

      <p>
        Votre score : {{ score }} / {{ questions.length }}
        ‚Äî Seuil (70%) : {{ threshold }} sur {{questions.length}}
      </p>

      <!-- ‚úÖ SUCC√àS P3 : texte sp√©cifique -->
      <p *ngIf="passed && bank === 'p3'" class="result-message success">
        Bravo ! üéâ Votre entra√Ænement a port√© ses fruits !
        Vous avez au moins atteint les 70 % demand√©s.
        Nous vous invitons maintenant √† vous inscrire √† l'√©valuation √©crite
        <a
          href="https://corder.be/fr/agenda-des-evaluations"
          target="_blank"
          rel="noopener"
        >
          Agenda des √©valuations phytolicence | CORDER ASBL
        </a>
        et √† prendre connaissance des exemples de questions orales afin de vous entra√Æner
        pour la seconde partie de l'√©valuation.
      </p>

      <!-- ‚úÖ SUCC√àS autres banques -->
      <p *ngIf="passed && bank !== 'p3'" class="result-message success">
        Bravo ! üéâ Votre entra√Ænement a port√© ses fruits : vous avez atteint au moins les 70 % requis.
      </p>

      <!-- ‚ùå √âCHEC : bouton accueil visible en haut -->
      <div *ngIf="!passed" class="fail-top-actions">
        <a class="btn-home" [routerLink]="'/'">‚Üê Retour √† l'accueil</a>
        <button class="btn-retry" (click)="restart()">R√©essayer le quiz</button>
      </div>

      <!-- ‚úÖ √âCHEC : texte + ressources -->
      <div *ngIf="!passed" class="fail-block">
        <p class="result-message info">
          Vous n‚Äôavez pas atteint les 70 % requis. Nous vous invitons √† approfondir la mati√®re √† l‚Äôaide des ressources suivantes avant de retenter votre chance :
        </p>

        <ul class="fail-links">
          <li>
            L√©gislation relative √† l‚Äôutilisation des PPP (au sens large), et applicable en Wallonie :
            <a href="https://corder.be/fr/crphyto" target="_blank" rel="noopener">https://corder.be/fr/crphyto</a>
          </li>
          <li>
            Maladies et moyens de lutte en pathologie v√©g√©tale :
            <a href="https://www.appi.be/fr" target="_blank" rel="noopener">https://www.appi.be/fr</a>
          </li>
          <li>
            Calculs dilution de cuve, largeurs effectives de zone tampon, buses‚Ä¶ :
            <a href="https://www.protecteau.be/fr/la-dilution-du-fond-de-cuve" target="_blank" rel="noopener">https://www.protecteau.be/fr/la-dilution-du-fond-de-cuve</a>
            ;
            <a href="https://www.protecteau.be/fr" target="_blank" rel="noopener">https://www.protecteau.be/fr</a>
          </li>
          <li>
            Gestion des r√©sistances :
            <a href="https://www.corder.be/fr/news/gestion-des-especes-resistantes-aux-produits-phytopharmaceutiques" target="_blank" rel="noopener">
              https://www.corder.be/fr/news/gestion-des-especes-resistantes-aux-produits-phytopharmaceutiques
            </a>
          </li>
          <li>
            Pour tout ce qui est relatif √† la s√©curit√© :
            <a href="https://secteursverts.be/" target="_blank" rel="noopener">Mission Wallonne des Secteurs Verts - Preventagri</a>
          </li>
        </ul>
      </div>

      <section *ngIf="wrongAnswers.length > 0" class="results">
        <h3>Vos erreurs</h3>

        <div class="result-item" *ngFor="let r of wrongAnswers">
          <p class="question-text" [innerHTML]="r.question.question"></p>

          <p class="answer-line">
            <span class="label">Votre r√©ponse :</span>
            <span *ngIf="r.selected; else noAnswer">
              {{ formatAnswer(r.question, r.selected) }}
            </span>
          </p>

          <ng-template #noAnswer>
            <span>aucune r√©ponse</span>
          </ng-template>

          <p class="answer-line">
            <span class="label">Bonne r√©ponse :</span>
            {{ formatAnswer(r.question, r.question.answer) }}
          </p>
        </div>
      </section>

      <div class="end-actions">
        <button (click)="restart()">
          Refaire le quiz pour t'am√©liorer
        </button>
        <a class="back-home" [routerLink]="'/'">
          Retour √† l'accueil
        </a>
      </div>
    </ng-template>

  </ng-container>
</div>

<!-- MODAL IMAGE -->
<div
  *ngIf="isImageOpen && current?.image"
  class="image-overlay"
  (click)="closeImage()"
>
  <div class="image-wrapper" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeImage()">‚úï</button>

    <img
      [src]="current?.image"
      class="image-large"
      alt="Image agrandie"
    />
  </div>
</div>
