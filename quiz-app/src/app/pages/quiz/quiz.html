<div class="container">
  <h1>Quiz</h1>

  <div *ngIf="loading">Chargement...</div>
  <div *ngIf="error">{{ error }}</div>

  <ng-container *ngIf="!loading && !error">
    <div *ngIf="current as q; else finished">

      <!-- TOP BAR -->
      <div class="topbar">
        <div>Question {{ index + 1 }} / {{ questions.length }}</div>
        <div class="topbar-right">
          <span>Score: {{ score }}</span>
          <a class="back-home" [routerLink]="'/'">Accueil</a>
        </div>
      </div>

      <!-- QUESTION -->
      <h2 class="question">{{ q.question }}</h2>

      <!-- IMAGE CLIQUABLE -->
      <img
        *ngIf="q.image"
        class="question-image clickable"
        [src]="q.image"
        [alt]="'Illustration de la question ' + (index + 1)"
        (click)="openImage()"
      />

      <!-- CHOIX -->
      <div class="choices">
        <button
          *ngFor="let c of q.choices"
          (click)="select(c.key)"
          [class.selected]="selected === c.key"
          [class.correct]="showCorrection && c.key === q.answer"
          [class.wrong]="showCorrection && selected === c.key && c.key !== q.answer"
        >
          <span class="key">{{ c.key.toUpperCase() }}</span>
          <span>{{ c.text }}</span>
        </button>
      </div>

      <!-- NAVIGATION (TOUJOURS VISIBLE) -->
      <div class="nav-buttons">
        <button
          class="prev"
          (click)="previous()"
          [disabled]="index === 0"
        >
          Pr√©c√©dent
        </button>

        <button
          class="next"
          (click)="next()"
          [disabled]="!canGoNext"
        >
          {{ index === questions.length - 1 ? 'Terminer' : 'Suivant' }}
        </button>
      </div>

      <!-- FEEDBACK -->
      <div class="feedback" *ngIf="showCorrection">
        <p *ngIf="isCorrect" class="ok">‚úÖ Correct</p>
        <p *ngIf="isCorrect === false" class="no">
          ‚ùå Faux (bonne r√©ponse : {{ q.answer.toUpperCase() }})
        </p>

        <p *ngIf="q.explanation">{{ q.explanation }}</p>
      </div>

    </div>

    <!-- FIN DU QUIZ -->
    <ng-template #finished>
      <h2>Termin√© üéâ</h2>
      <p>
        Ton score : {{ score }} / {{ questions.length }}
        ‚Äî Seuil (70%) : {{ threshold }}
      </p>
      
      <p *ngIf="passed" class="result-message success">
        Bravo, tu as r√©ussi le quiz ! ü•≥
      </p>
      <p *ngIf="!passed" class="result-message info">
        Ce n‚Äôest pas encore valid√©, mais tu peux progresser rapidement en refaisant le quiz.
      </p>

      <section *ngIf="wrongAnswers.length > 0" class="results">
        <h3>Tes erreurs</h3>

        <div class="result-item" *ngFor="let r of wrongAnswers">
          <p class="question-text">{{ r.question.question }}</p>

          <p class="answer-line">
            <span class="label">Ta r√©ponse :</span>
            <span *ngIf="r.selected; else noAnswer">
              {{ formatAnswer(r.question, r.selected) }}
            </span>
          </p>

          <ng-template #noAnswer>
            <span>aucune r√©ponse</span>
          </ng-template>

          <p class="answer-line">
            <span class="label">Bonne r√©ponse :</span>
            {{ formatAnswer(r.question, r.question.answer) }}
          </p>
        </div>
      </section>

      <div class="end-actions">
        <button (click)="restart()">
          Refaire le quiz pour t'am√©liorer
        </button>
        <a class="back-home" [routerLink]="'/'">
          Retour √† l'accueil
        </a>
      </div>
    </ng-template>

  </ng-container>
</div>

<!-- MODAL IMAGE -->
<div
  *ngIf="isImageOpen && current?.image"
  class="image-overlay"
  (click)="closeImage()"
>
  <div class="image-wrapper" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeImage()">‚úï</button>

    <img
      [src]="current?.image"
      class="image-large"
      alt="Image agrandie"
    />
  </div>
</div>
